name: Publish Package
on:
  workflow_dispatch:
    inputs:
      package:
        description: Name of the package to release
        required: true
      version:
        description: Version to release
        required: true
jobs:
  prepare:
    runs-on: ubuntu-latest
    name: 'Prepare a new version'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-node
      - name: Prepare
        id: prepare
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          release_branch=$(yarn workspace @formsort/${{ github.event.inputs.package }} run craft prepare ${{ github.event.inputs.version }} | -Po '(?<=Pushing the release branch ")release/.+/.+(?=")')
          echo ::set-output name=release_branch::$release_branch
      - name: Build
        uses: ./.github/workflows/build.yml
        with:
          ref: ${{ steps.prepare.outputs.release_branch }}
  publish:
    runs-on: ubuntu-latest
    needs: prepare
    environment: release
    name: 'Publish the new version'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: ./.github/actions/setup-node
      - name: Publish
        env:
          GITHUB_TOKEN: ${{ github.token }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: >-
          yarn workspace @formsort/${{ github.event.inputs.package }} run craft publish ${{ github.event.inputs.version }}
